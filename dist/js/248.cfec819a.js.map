{"version":3,"file":"js/248.cfec819a.js","mappings":"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","sources":["webpack://tohsaka_blog/./src/pages/photoAlbum.vue","webpack://tohsaka_blog/src/pages/photoAlbum.vue","webpack://tohsaka_blog/./src/pages/photoAlbum.vue?32f4","webpack://tohsaka_blog/./src/pages/photoAlbum.vue?5428"],"sourcesContent":["var render = function render(){var _vm=this,_c=_vm._self._c;return _c('div',{ref:\"waterfall\",attrs:{\"id\":\"waterfall\"}},_vm._l((_vm.imgsArr_c),function(item,index){return _c('div',{key:index,ref:\"imgBox\",refInFor:true,staticClass:\"img-box default-card-animation\",style:({ width: _vm.imgWidth + 'px', height: item._height + 'px' })},[_c('img',{attrs:{\"data-src\":item.src}})])}),0)\n}\nvar staticRenderFns = []\n\nexport { render, staticRenderFns }","<template>\r\n  <div id=\"waterfall\" ref=\"waterfall\">\r\n    <div\r\n      class=\"img-box default-card-animation\"\r\n      v-for=\"(item, index) in imgsArr_c\"\r\n      :key=\"index\"\r\n      :style=\"{ width: imgWidth + 'px', height: item._height + 'px' }\"\r\n      ref=\"imgBox\"\r\n    >\r\n      <img :data-src=\"item.src\" />\r\n    </div>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nimport { mapState } from \"vuex\";\r\nexport default {\r\n  name: \"waterfall\",\r\n  data() {\r\n    return {\r\n      imgsArr: [],\r\n      imgsArr_c: [], // 渲染的图片\r\n      imgCol: 5, // 图片列数\r\n      imgGap: 5, // 图片间间隔\r\n      loadedCount: 0,\r\n      newCounts: 20,\r\n      theFirst: 0,\r\n      cNumber: 0,\r\n      imgBoxEls: [], // 所有 img-box 元素\r\n      beginIndex: 0,\r\n      colsHeightArr: [], // 保存当前每一列的高度\r\n      reachBottomDistance: -500, // 滚动触底距离，触发加载新图片\r\n      viewHeight: 0, // 窗口视图大小\r\n    };\r\n  },\r\n  computed: {\r\n    // 容器 waterfall 的宽度\r\n    ...mapState(\"image\", [\"imgaesUrlList\"]),\r\n    waterfallWidth() {\r\n      return this.$refs[\"waterfall\"].clientWidth - 9;\r\n    },\r\n    // 图片宽度\r\n    imgWidth() {\r\n      return this.colWidth - 2 * this.imgGap;\r\n    },\r\n    // 列宽度\r\n    colWidth() {\r\n      return this.waterfallWidth / this.colNum;\r\n    },\r\n    // 列数\r\n    colNum() {\r\n      return this.isMobile ? 2 : this.imgCol;\r\n    },\r\n  },\r\n  watch: {\r\n    imgsArr(newVal, oldVal) {\r\n      if (\r\n        this.imgsArr_c.length > newVal.length ||\r\n        (this.imgsArr_c.left > 0 && newVal[0] && !newVal[0]._height)\r\n      )\r\n        this.reset();\r\n      this.preLoad();\r\n    },\r\n  },\r\n  methods: {\r\n    // 预加载 设置图片宽高\r\n    preLoad() {\r\n      //\r\n      // forEach 无法通过 item 直接修改数组元素，需用数组下标修改\r\n      this.imgsArr.forEach((item, index) => {\r\n        if (index < this.loadedCount) return;\r\n        // 无图则把高度设置为0\r\n        if (!item.src) {\r\n          // 图片的高度\r\n          this.imgsArr[index]._height = \"0\";\r\n          ++this.loadedCount;\r\n          // 当前图片都与处理完，则加载图片\r\n          if (this.imgsArr.length === this.loadedCount) {\r\n            this.preloaded();\r\n          }\r\n          console.log(111111);\r\n        } else {\r\n          let img = new Image();\r\n          img.src = item.src;\r\n          img.onload = img.onerror = (e) => {\r\n            // 若加载失败则设置图片高度与宽度一致，加载成功则动态计算图片高度\r\n            this.imgsArr[index]._height =\r\n              e.type === \"load\"\r\n                ? Math.round(this.imgWidth * (img.height / img.width))\r\n                : this.imgWidth;\r\n            if (e.type === \"error\") {\r\n              this.imgsArr[index]._error = true;\r\n            }\r\n            ++this.loadedCount;\r\n            // 当前图片都与处理完，则加载图片\r\n            if (this.imgsArr.length === this.loadedCount) {\r\n              this.preloaded(this.cNumber);\r\n            }\r\n          };\r\n        }\r\n      });\r\n    },\r\n    preloaded(cNumber) {\r\n      if (this.theFirst == 0) {\r\n        for (let i = 0; i < 20; i++) {\r\n          this.imgsArr_c.push(this.imgsArr[i]);\r\n        }\r\n        this.$nextTick(() => {\r\n          this.waterfall();\r\n        });\r\n      } else {\r\n        this.cNumber += 20;\r\n        for (let i = cNumber; i < this.cNumber; i++) {\r\n          this.imgsArr_c.push(this.imgsArr[i]);\r\n        }\r\n        this.$nextTick(() => {\r\n          this.waterfall();\r\n        });\r\n      }\r\n    },\r\n    // waterfall 布局\r\n    waterfall() {\r\n      // 等到整个视图都渲染完毕再执行\r\n\r\n      this.imgBoxEls = this.$refs[\"imgBox\"];\r\n      if (!this.imgBoxEls) return;\r\n      let top, left, height;\r\n      if (this.beginIndex === 0) this.colsHeightArr = [];\r\n      for (let i = this.beginIndex; i < this.imgBoxEls.length; ++i) {\r\n        if (!this.imgBoxEls[i]) return;\r\n        height = this.imgBoxEls[i].offsetHeight;\r\n        // 第一行\r\n        if (i < this.colNum) {\r\n          this.colsHeightArr.push(height);\r\n          top = 0;\r\n          left = i * this.colWidth;\r\n        } else {\r\n          // 找到最低的高度和其索引\r\n          let minHeight = Math.min.apply(null, this.colsHeightArr);\r\n          let minIdx = this.colsHeightArr.indexOf(minHeight);\r\n          top = minHeight;\r\n          left = minIdx * this.colWidth;\r\n          this.colsHeightArr[minIdx] += height;\r\n        }\r\n        // 设置 img-box 位置\r\n        this.imgBoxEls[i].style.top = top + \"px\";\r\n        this.imgBoxEls[i].style.left = left + \"px\";\r\n        // 当前图片在窗口内，则加载\r\n        if (top < this.viewHeight) {\r\n          let imgEl = this.imgBoxEls[i].children[0];\r\n          imgEl.src = imgEl.getAttribute(\"data-src\");\r\n          imgEl.style.opacity = 1;\r\n          imgEl.style.transform = \"scale(1)\";\r\n        }\r\n      }\r\n      this.beginIndex = this.imgBoxEls.length;\r\n    },\r\n    reset() {\r\n      this.imgsArr_c = [];\r\n      this.beginIndex = [];\r\n      this.loadedCount = 0;\r\n    },\r\n    // 滚动触底事件\r\n    scrollFn() {\r\n      let minHeight = Math.min.apply(null, this.colsHeightArr);\r\n      // 滚动条滚动的高度\r\n      let scrollTop =\r\n        window.pageYOffset ||\r\n        document.documentElement.scrollTop ||\r\n        document.body.scrollTop;\r\n      // 到达最底层的高度最低的一列，则触发 handleReachBottom 方法\r\n      if (scrollTop + this.viewHeight > minHeight - this.reachBottomDistance) {\r\n        this.handleReachBottom();\r\n      }\r\n      // 图片懒加载\r\n      this.imgBoxEls.forEach((imgBoxEl, index) => {\r\n        let imgEl = imgBoxEl.children[0];\r\n        // 若已加载，则跳过\r\n        if (imgEl.src) return;\r\n        // 当前图片所处的高度\r\n        let top = imgBoxEl.style.top;\r\n        top = Number.parseFloat(top.slice(0, top.length - 2));\r\n\r\n        // 图片已到达可视范围，则加载\r\n        if (scrollTop + this.viewHeight >= top) {\r\n          imgEl.src = imgEl.getAttribute(\"data-src\");\r\n          imgEl.style.opacity = 1;\r\n\r\n          imgEl.style.transform = \"scale(1)\";\r\n        }\r\n      });\r\n    },\r\n    scroll() {\r\n      window.onscroll = this.throttle(this.scrollFn, 500);\r\n    },\r\n    handleReachBottom() {\r\n      setTimeout(() => {\r\n        this.loadImages(this.newCounts);\r\n      }, 500);\r\n\r\n      console.log(\"--this.imgsArr--\", this.imgsArr);\r\n    },\r\n    // 节流函数\r\n    throttle(fn, time) {\r\n      let canRun = true;\r\n\r\n      return function () {\r\n        if (!canRun) return;\r\n        canRun = false;\r\n        setTimeout(() => {\r\n          fn.apply(this);\r\n\r\n          canRun = true;\r\n        }, time);\r\n      };\r\n    },\r\n    loadImages(newCounts) {\r\n      this.$store.dispatch(\"image/getImagesList\");\r\n      this.newCounts += 20;\r\n      for (let i = newCounts; i < this.newCounts; i++) {\r\n        let img = {\r\n          src: \"\",\r\n          href: \"\",\r\n          info: \"\",\r\n        };\r\n        img.src = this.imgaesUrlList[i];\r\n        img.href = i;\r\n        img.info = i;\r\n        this.imgsArr.push(img);\r\n      }\r\n\r\n      console.log(this.imgsArr);\r\n    },\r\n  },\r\n  created() {\r\n    this.$store.dispatch(\"image/getImagesList\");\r\n    setTimeout(() => {\r\n      for (let i = 0; i < 20; i++) {\r\n        let img = {\r\n          src: \"\",\r\n          href: \"\",\r\n          info: \"\",\r\n        };\r\n        img.src = this.imgaesUrlList[i];\r\n        img.href = i;\r\n        img.info = i;\r\n        this.imgsArr.push(img);\r\n      }\r\n      this.theFirst = 1;\r\n    }, 300);\r\n  },\r\n  mounted() {\r\n    this.viewHeight =\r\n      document.documentElement.clientHeight == 0\r\n        ? document.body.clientHeight\r\n        : document.documentElement.clientHeight;\r\n    this.preLoad();\r\n    this.scroll();\r\n  },\r\n};\r\n</script>\r\n\r\n<!-- Add \"scoped\" attribute to limit CSS to this component only -->\r\n<style scoped >\r\n#waterfall {\r\n  width: 100%;\r\n  margin-top: 5rem;\r\n  position: relative;\r\n}\r\n@keyframes show-card {\r\n  0% {\r\n    transform: scale(0.5);\r\n  }\r\n\r\n  100% {\r\n    transform: scale(1);\r\n  }\r\n}\r\n\r\n.img-box {\r\n  position: absolute;\r\n  border-radius: 10px;\r\n  padding: 5px;\r\n  padding-left: 0;\r\n  z-index: -3;\r\n}\r\n.img-box img {\r\n  position: relative;\r\n  padding-left: 10px;\r\n  width: 100%;\r\n  border-radius: 15px;\r\n  opacity: 0;\r\n  transform: scale(0.5);\r\n  transition: all 0.3s;\r\n  cursor: pointer;\r\n}\r\n.img-box img:hover {\r\n  scale: 1.05;\r\n  opacity: 0.8;\r\n}\r\n\r\n.default-card-animation {\r\n  animation: show-card 0.4s;\r\n  transition: left 0.6s top 0.6s;\r\n  transition-delay: 0.1s;\r\n}\r\n</style>","import mod from \"-!../../node_modules/thread-loader/dist/cjs.js!../../node_modules/babel-loader/lib/index.js??clonedRuleSet-40.use[1]!../../node_modules/@vue/vue-loader-v15/lib/index.js??vue-loader-options!./photoAlbum.vue?vue&type=script&lang=js&\"; export default mod; export * from \"-!../../node_modules/thread-loader/dist/cjs.js!../../node_modules/babel-loader/lib/index.js??clonedRuleSet-40.use[1]!../../node_modules/@vue/vue-loader-v15/lib/index.js??vue-loader-options!./photoAlbum.vue?vue&type=script&lang=js&\"","import { render, staticRenderFns } from \"./photoAlbum.vue?vue&type=template&id=7699f9b8&scoped=true&\"\nimport script from \"./photoAlbum.vue?vue&type=script&lang=js&\"\nexport * from \"./photoAlbum.vue?vue&type=script&lang=js&\"\nimport style0 from \"./photoAlbum.vue?vue&type=style&index=0&id=7699f9b8&prod&scoped=true&lang=css&\"\n\n\n/* normalize component */\nimport normalizer from \"!../../node_modules/@vue/vue-loader-v15/lib/runtime/componentNormalizer.js\"\nvar component = normalizer(\n  script,\n  render,\n  staticRenderFns,\n  false,\n  null,\n  \"7699f9b8\",\n  null\n  \n)\n\nexport default component.exports"],"names":["render","_vm","this","_c","_self","ref","attrs","_l","imgsArr_c","item","index","key","refInFor","staticClass","style","width","imgWidth","height","_height","src","staticRenderFns","name","data","imgsArr","imgCol","imgGap","loadedCount","newCounts","theFirst","cNumber","imgBoxEls","beginIndex","colsHeightArr","reachBottomDistance","viewHeight","computed","waterfallWidth","colWidth","colNum","watch","methods","preLoad","img","e","Math","console","preloaded","waterfall","top","left","imgEl","reset","scrollFn","window","document","scroll","handleReachBottom","setTimeout","throttle","canRun","fn","time","loadImages","href","info","created","mounted","component"],"sourceRoot":""}